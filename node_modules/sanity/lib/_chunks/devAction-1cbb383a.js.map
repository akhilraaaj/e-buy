{"version":3,"file":"devAction-1cbb383a.js","sources":["../../src/_internal/cli/server/devServer.ts","../../src/_internal/cli/actions/dev/devAction.ts"],"sourcesContent":["import chalk from 'chalk'\nimport {createServer, InlineConfig} from 'vite'\nimport {getViteConfig} from './getViteConfig'\nimport {debug} from './debug'\nimport {writeSanityRuntime} from './runtime'\n\nexport interface DevServerOptions {\n  cwd: string\n  basePath: string\n  staticPath: string\n\n  httpPort: number\n  httpHost?: string\n  projectName?: string\n\n  reactStrictMode: boolean\n  vite?: (config: InlineConfig) => InlineConfig\n}\n\nexport interface DevServer {\n  close(): Promise<void>\n}\n\nexport async function startDevServer(options: DevServerOptions): Promise<DevServer> {\n  const {cwd, httpPort, httpHost, basePath, reactStrictMode, vite: extendViteConfig} = options\n\n  const startTime = Date.now()\n  debug('Writing Sanity runtime files')\n  await writeSanityRuntime({cwd, reactStrictMode, watch: true, basePath})\n\n  debug('Resolving vite config')\n  let viteConfig = await getViteConfig({\n    basePath,\n    mode: 'development',\n    server: {port: httpPort, host: httpHost},\n    cwd,\n  })\n\n  if (extendViteConfig) {\n    debug('Extending vite config using user-specified function')\n    viteConfig = extendViteConfig(viteConfig)\n  }\n\n  debug('Creating vite server')\n  const server = await createServer(viteConfig)\n  const info = server.config.logger.info\n\n  debug('Listening on specified port')\n  await server.listen()\n\n  const startupDuration = Date.now() - startTime\n  const url = `http://${httpHost || 'localhost'}:${httpPort || '3333'}${basePath}`\n  info(\n    `Sanity Studio ` +\n      `using ${chalk.cyan(`vite@${require('vite/package.json').version}`)} ` +\n      `ready in ${chalk.cyan(`${Math.ceil(startupDuration)}ms`)} ` +\n      `and running at ${chalk.cyan(url)}`\n  )\n\n  return {close: () => server.close()}\n}\n","import path from 'path'\nimport type {CliConfig, CliCommandArguments, CliCommandContext, CliOutputter} from '@sanity/cli'\nimport {DevServerOptions, startDevServer} from '../../server/devServer'\nimport {getTimer} from '../../util/timing'\nimport {checkStudioDependencyVersions} from '../../util/checkStudioDependencyVersions'\nimport {checkRequiredDependencies} from '../../util/checkRequiredDependencies'\nimport {getSharedServerConfig, gracefulServerDeath} from '../../util/servers'\n\nexport interface StartDevServerCommandFlags {\n  host?: string\n  port?: string\n}\n\nexport default async function startSanityDevServer(\n  args: CliCommandArguments<StartDevServerCommandFlags>,\n  context: CliCommandContext\n): Promise<void> {\n  const timers = getTimer()\n  const flags = args.extOptions\n  const {output, workDir, cliConfig} = context\n\n  timers.start('checkStudioDependencyVersions')\n  checkStudioDependencyVersions(workDir)\n  timers.end('checkStudioDependencyVersions')\n\n  // If the check resulted in a dependency install, the CLI command will be re-run,\n  // thus we want to exit early\n  if ((await checkRequiredDependencies(context)).didInstall) {\n    return\n  }\n\n  // Try to load CLI configuration from sanity.cli.(js|ts)\n  const config = getDevServerConfig({flags, workDir, cliConfig, output})\n\n  try {\n    await startDevServer(config)\n  } catch (err) {\n    gracefulServerDeath('dev', config.httpHost, config.httpPort, err)\n  }\n}\n\nfunction getDevServerConfig({\n  flags,\n  workDir,\n  cliConfig,\n  output,\n}: {\n  flags: StartDevServerCommandFlags\n  workDir: string\n  cliConfig?: CliConfig\n  output: CliOutputter\n}): DevServerOptions {\n  const configSpinner = output.spinner('Checking configuration files...')\n  const baseConfig = getSharedServerConfig({flags, workDir, cliConfig})\n  configSpinner.succeed()\n\n  const env = process.env // eslint-disable-line no-process-env\n  const reactStrictMode = env.SANITY_STUDIO_REACT_STRICT_MODE\n    ? env.SANITY_STUDIO_REACT_STRICT_MODE === 'true'\n    : Boolean(cliConfig?.reactStrictMode)\n\n  if (env.SANITY_STUDIO_BASEPATH && cliConfig?.project?.basePath) {\n    output.warn(\n      `Overriding configured base path (${cliConfig.project.basePath}) with value from environment variable (${env.SANITY_STUDIO_BASEPATH})`\n    )\n  }\n\n  return {\n    ...baseConfig,\n    staticPath: path.join(workDir, 'static'),\n    reactStrictMode,\n  }\n}\n"],"names":["startDevServer","options","cwd","httpPort","httpHost","basePath","reactStrictMode","vite","extendViteConfig","startTime","Date","now","debug","writeSanityRuntime","watch","viteConfig","getViteConfig","mode","server","port","host","createServer","info","config","logger","listen","startupDuration","url","chalk","cyan","require","version","Math","ceil","default","close","startSanityDevServer","args","context","timers","getTimer","flags","extOptions","output","workDir","cliConfig","start","checkStudioDependencyVersions","end","checkRequiredDependencies","didInstall","getDevServerConfig","err","gracefulServerDeath","_a","configSpinner","spinner","baseConfig","getSharedServerConfig","succeed","env","process","SANITY_STUDIO_REACT_STRICT_MODE","Boolean","SANITY_STUDIO_BASEPATH","project","warn","staticPath","path","join"],"mappings":"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"}